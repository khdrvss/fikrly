{% extends 'base.html' %}
{% load static i18n %}

{% block title %}{% trans "Mening darajam | Fikrly" %}{% endblock %}

{% block content %}
<div class="py-8">
    <div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8">

        <!-- Header -->
        <div class="mb-8">
            <a href="{% url 'user_profile' %}" class="inline-flex items-center gap-1 text-sm text-[var(--text-secondary)] hover:text-[var(--accent)] transition-colors mb-4">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                </svg>
                {% trans "Profilga qaytish" %}
            </a>
            <h1 class="text-2xl font-bold text-[var(--text-primary)]">{% trans "Mening darajam va yutuqlarim" %}</h1>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

            <!-- Left: Level card -->
            <div class="lg:col-span-1 space-y-6">

                <!-- XP card -->
                <div class="bg-[var(--surface)] rounded-2xl border border-[var(--border)] shadow-sm p-6 text-center">
                    <div class="w-20 h-20 mx-auto bg-primary-100 rounded-full flex items-center justify-center mb-4">
                        <span class="text-3xl font-bold text-primary-700">{{ gamification.level }}</span>
                    </div>
                    <h2 class="text-lg font-bold text-[var(--text-primary)] mb-1">{% trans "Daraja" %} {{ gamification.level }}</h2>
                    <p class="text-sm text-[var(--text-secondary)] mb-4">{{ gamification.xp }} XP</p>

                    <!-- Progress bar -->
                    <div class="mb-1 flex justify-between text-xs text-[var(--text-secondary)]">
                        <span>{{ gamification.xp }} XP</span>
                        <span>{{ gamification.next_level_xp }} XP</span>
                    </div>
                    <div class="w-full bg-[var(--border)] rounded-full h-2.5">
                        <div class="bg-[var(--accent)] h-2.5 rounded-full transition-all" style="width: {{ gamification.xp_progress|floatformat:0 }}%"></div>
                    </div>
                    <p class="text-xs text-[var(--text-secondary)] mt-2">
                        {% blocktrans with next=gamification.next_level_xp %}Keyingi daraja uchun {{ next }} XP kerak{% endblocktrans %}
                    </p>
                </div>

                <!-- Stats -->
                <div class="bg-[var(--surface)] rounded-2xl border border-[var(--border)] shadow-sm p-5">
                    <h3 class="text-sm font-semibold text-[var(--text-primary)] mb-4">{% trans "Statistika" %}</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-[var(--text-secondary)]">{% trans "Jami sharhlar" %}</span>
                            <span class="font-semibold text-[var(--text-primary)]">{{ gamification.total_reviews }}</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-[var(--text-secondary)]">{% trans "Foydali ovozlar" %}</span>
                            <span class="font-semibold text-[var(--text-primary)]">{{ gamification.helpful_votes_received }}</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-[var(--text-secondary)]">{% trans "Bizneslar" %}</span>
                            <span class="font-semibold text-[var(--text-primary)]">{{ gamification.companies_reviewed }}</span>
                        </div>
                        <div class="flex justify-between items-center border-t border-[var(--border)] pt-3">
                            <span class="text-sm text-[var(--text-secondary)]">üî• {% trans "Joriy seriya" %}</span>
                            <span class="font-semibold text-orange-500">{{ gamification.current_streak }} {% trans "kun" %}</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-[var(--text-secondary)]">{% trans "Eng uzun seriya" %}</span>
                            <span class="font-semibold text-[var(--text-primary)]">{{ gamification.longest_streak }} {% trans "kun" %}</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right: Badges + Leaderboard -->
            <div class="lg:col-span-2 space-y-6">

                <!-- My Badges -->
                <div class="bg-[var(--surface)] rounded-2xl border border-[var(--border)] shadow-sm p-6">
                    <h3 class="text-base font-semibold text-[var(--text-primary)] mb-4">{% trans "Mening yutuqlarim" %} ({{ badges.count }})</h3>
                    {% if badges %}
                    <div class="grid grid-cols-2 sm:grid-cols-3 gap-3">
                        {% for b in badges %}
                        <div class="flex items-center gap-3 bg-[var(--bg)] rounded-xl border border-[var(--border)] px-3 py-2 {% if b.is_new %}ring-2 ring-primary-400{% endif %}">
                            <span class="text-2xl flex-shrink-0">{{ b.icon }}</span>
                            <div>
                                <div class="text-xs font-semibold text-[var(--text-primary)]">{{ b.name }}</div>
                                <div class="text-xs text-[var(--text-secondary)]">{{ b.earned_at|date:"d M Y" }}</div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="text-center py-8">
                        <div class="text-4xl mb-2">üèÖ</div>
                        <p class="text-sm text-[var(--text-secondary)]">{% trans "Hali yutuq yo'q. Sharh yozib boshlang!" %}</p>
                    </div>
                    {% endif %}

                    <!-- Available to earn -->
                    {% if available_badges %}
                    <div class="mt-5 pt-5 border-t border-[var(--border)]">
                        <h4 class="text-sm font-medium text-[var(--text-secondary)] mb-3">{% trans "Qo'lga kiritish mumkin" %}</h4>
                        <div class="flex flex-wrap gap-2">
                            {% for ab in available_badges %}
                            <span class="px-3 py-1 bg-[var(--border)] text-[var(--text-secondary)] text-xs rounded-full">{{ ab.name }}</span>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                </div>

                <!-- Leaderboard -->
                <div class="bg-[var(--surface)] rounded-2xl border border-[var(--border)] shadow-sm p-6">
                    <h3 class="text-base font-semibold text-[var(--text-primary)] mb-4">{% trans "Top 10 sharhchilar" %}</h3>
                    <div class="space-y-2">
                        {% for entry in leaderboard %}
                        <div class="flex items-center gap-3 p-2 rounded-xl {% if entry.user == request.user %}bg-primary-50 border border-primary-100{% endif %}">
                            <span class="w-6 text-center text-sm font-bold
                                {% if forloop.counter == 1 %}text-yellow-500
                                {% elif forloop.counter == 2 %}text-slate-400
                                {% elif forloop.counter == 3 %}text-amber-600
                                {% else %}text-[var(--text-secondary)]{% endif %}">
                                {% if forloop.counter == 1 %}ü•á{% elif forloop.counter == 2 %}ü•à{% elif forloop.counter == 3 %}ü•â{% else %}{{ forloop.counter }}{% endif %}
                            </span>
                            <div class="w-7 h-7 rounded-full bg-primary-100 flex items-center justify-center text-primary-700 text-xs font-bold flex-shrink-0">
                                {{ entry.user.get_username|first|upper }}
                            </div>
                            <div class="flex-1 min-w-0">
                                <div class="text-sm font-medium text-[var(--text-primary)] truncate">
                                    {{ entry.user.get_full_name|default:entry.user.username }}
                                    {% if entry.user == request.user %}
                                    <span class="text-xs text-primary-600 ml-1">({% trans "Sen" %})</span>
                                    {% endif %}
                                </div>
                                <div class="text-xs text-[var(--text-secondary)]">{% trans "Daraja" %} {{ entry.level }}</div>
                            </div>
                            <span class="text-sm font-semibold text-[var(--text-primary)] flex-shrink-0">{{ entry.xp }} XP</span>
                        </div>
                        {% endfor %}
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>
{% endblock %}
