{% extends 'base.html' %}
{% load static %}

{% block title %}Analytics Dashboard - {{ company.name }} - Fikrly{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8 dark:bg-gray-900 dark:text-white">
    <div class="mb-8">
        <h1 class="text-3xl font-bold mb-2 dark:text-white">üìä Analytics Dashboard</h1>
        <p class="text-[var(--text-secondary)] dark:text-gray-300">{{ company.name }}</p>
    </div>
    
    <!-- Time Range Filter -->
    <div class="mb-6">
        <div class="inline-flex rounded-lg shadow-sm" role="group">
            <a href="?days=7" class="px-4 py-2 text-sm font-medium {% if days == 7 %}bg-[var(--accent)] text-white{% else %}bg-[var(--surface)] dark:bg-gray-800 text-[var(--text-primary)] dark:text-gray-300 hover:bg-[var(--bg)] dark:hover:bg-gray-700{% endif %} border border-[var(--border)] dark:border-gray-700 rounded-l-lg">
                7 kun
            </a>
            <a href="?days=30" class="px-4 py-2 text-sm font-medium {% if days == 30 %}bg-[var(--accent)] text-white{% else %}bg-[var(--surface)] dark:bg-gray-800 text-[var(--text-primary)] dark:text-gray-300 hover:bg-[var(--bg)] dark:hover:bg-gray-700{% endif %} border-t border-b border-[var(--border)] dark:border-gray-700">
                30 kun
            </a>
            <a href="?days=90" class="px-4 py-2 text-sm font-medium {% if days == 90 %}bg-[var(--accent)] text-white{% else %}bg-[var(--surface)] dark:bg-gray-800 text-[var(--text-primary)] dark:text-gray-300 hover:bg-[var(--bg)] dark:hover:bg-gray-700{% endif %} border border-[var(--border)] dark:border-gray-700 rounded-r-lg">
                90 kun
            </a>
        </div>
    </div>
    
    <!-- Stats Grid -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
        <div class="bg-[var(--surface)] dark:bg-gray-800 rounded-lg shadow p-6">
            <div class="text-[var(--text-secondary)] dark:text-gray-400 text-sm mb-1">Jami sharhlar</div>
            <div class="text-3xl font-bold dark:text-white">{{ stats.total_reviews }}</div>
        </div>
        <div class="bg-[var(--surface)] dark:bg-gray-800 rounded-lg shadow p-6">
            <div class="text-[var(--text-secondary)] dark:text-gray-400 text-sm mb-1">O'rtacha reyting</div>
            <div class="text-3xl font-bold text-yellow-500">{{ stats.average_rating|floatformat:1 }}</div>
        </div>
        <div class="bg-[var(--surface)] dark:bg-gray-800 rounded-lg shadow p-6">
            <div class="text-[var(--text-secondary)] dark:text-gray-400 text-sm mb-1">Javob darajasi</div>
            <div class="text-3xl font-bold text-green-500">{{ stats.response_rate }}%</div>
        </div>
        <div class="bg-[var(--surface)] dark:bg-gray-800 rounded-lg shadow p-6">
            <div class="text-[var(--text-secondary)] dark:text-gray-400 text-sm mb-1">Yangi sharhlar</div>
            <div class="text-3xl font-bold text-blue-500">{{ stats.new_reviews }}</div>
        </div>
    </div>
    
    <!-- Charts -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
        <!-- Reviews Over Time -->
        <div class="bg-[var(--surface)] dark:bg-gray-800 rounded-lg shadow p-6">
            <h3 class="text-lg font-semibold mb-4 dark:text-white">Sharhlar grafigi</h3>
            <canvas id="reviewsChart"></canvas>
        </div>
        
        <!-- Rating Distribution -->
        <div class="bg-[var(--surface)] dark:bg-gray-800 rounded-lg shadow p-6">
            <h3 class="text-lg font-semibold mb-4 dark:text-white">Reyting taqsimoti</h3>
            <canvas id="ratingChart"></canvas>
        </div>
    </div>
    
    <!-- Top Reviews -->
    <div class="bg-[var(--surface)] dark:bg-gray-800 rounded-lg shadow p-6 mb-8">
        <h3 class="text-lg font-semibold mb-4 dark:text-white">üèÜ Eng foydali sharhlar</h3>
        <div class="space-y-4">
            {% for review in top_reviews %}
            <div class="border-b dark:border-gray-700 pb-4 last:border-0">
                <div class="flex items-start justify-between">
                    <div class="flex-1">
                        <div class="font-medium dark:text-white">{{ review.user.get_full_name|default:review.user.username }}</div>
                        <div class="text-sm text-[var(--text-secondary)] dark:text-gray-300">{{ review.text|truncatewords:30 }}</div>
                    </div>
                    <div class="ml-4 flex items-center text-green-600 dark:text-green-400">
                        <svg class="w-5 h-5 mr-1" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M2 10.5a1.5 1.5 0 113 0v6a1.5 1.5 0 01-3 0v-6zM6 10.333v5.43a2 2 0 001.106 1.79l.05.025A4 4 0 008.943 18h5.416a2 2 0 001.962-1.608l1.2-6A2 2 0 0015.56 8H12V4a2 2 0 00-2-2 1 1 0 00-1 1v.667a4 4 0 01-.8 2.4L6.8 7.933a4 4 0 00-.8 2.4z"/>
                        </svg>
                        {{ review.helpful_count }}
                    </div>
                </div>
            </div>
            {% empty %}
            <p class="text-[var(--text-secondary)] dark:text-gray-400">Hali foydali sharhlar yo'q</p>
            {% endfor %}
        </div>
    </div>
    
    <!-- Pending Responses -->
    {% if pending_responses %}
    <div class="bg-yellow-50 dark:bg-yellow-900/20 rounded-lg shadow p-6">
        <h3 class="text-lg font-semibold mb-4 text-yellow-800 dark:text-yellow-200">‚è≥ Javob kutayotgan sharhlar</h3>
        <div class="space-y-3">
            {% for review in pending_responses %}
            <div class="flex items-center justify-between bg-[var(--surface)] dark:bg-gray-800 p-3 rounded">
                <div class="flex-1">
                    <div class="font-medium dark:text-white">{{ review.user.get_full_name|default:review.user.username }}</div>
                    <div class="text-sm text-[var(--text-secondary)] dark:text-gray-300">{{ review.text|truncatewords:20 }}</div>
                </div>
                <a href="{% url 'manager_review_response' review.id %}" class="ml-4 px-4 py-2 bg-[var(--accent)] hover:opacity-90 text-white rounded-lg text-sm">
                    Javob berish
                </a>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
    // Reviews over time chart
    const reviewsData = {{ reviews_over_time|safe }};
    const reviewsCtx = document.getElementById('reviewsChart').getContext('2d');
    new Chart(reviewsCtx, {
        type: 'line',
        data: {
            labels: reviewsData.map(d => d.date),
            datasets: [{
                label: 'Sharhlar',
                data: reviewsData.map(d => d.count),
                borderColor: '#00d68b',
                backgroundColor: 'rgba(0, 214, 139, 0.1)',
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { display: false }
            },
            scales: {
                y: { beginAtZero: true }
            }
        }
    });
    
    // Rating distribution chart
    const ratingData = {{ rating_distribution|safe }};
    const ratingCtx = document.getElementById('ratingChart').getContext('2d');
    new Chart(ratingCtx, {
        type: 'bar',
        data: {
            labels: ratingData.map(d => d.rating + ' ‚≠ê'),
            datasets: [{
                label: 'Sharhlar soni',
                data: ratingData.map(d => d.count),
                backgroundColor: [
                    '#ef4444',
                    '#f97316',
                    '#eab308',
                    '#84cc16',
                    '#22c55e'
                ]
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { display: false }
            },
            scales: {
                y: { beginAtZero: true }
            }
        }
    });
</script>
{% endblock %}
