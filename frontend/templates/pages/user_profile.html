{% extends 'base.html' %}
{% load static %}
{% load i18n %}

{% block title %}{{ request.user.get_full_name|default:request.user.username }} - {% trans "Profil | Fikrly" %}{% endblock %}

{% block content %}
    <!-- Toast Notification -->
    <div id="toastEmailSent" class="hidden fixed top-20 left-1/2 -translate-x-1/2 z-50 transform transition-all duration-300">
        <div class="flex items-center px-4 py-3 rounded-xl shadow-lg bg-green-600 text-white text-sm font-medium">
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
            </svg>
            {% trans "Email tasdiqlash yuborildi. Pochtangizni tekshiring." %}
        </div>
    </div>

    {% if profile and not profile.is_approved %}
    <div class="bg-amber-50 border-b border-amber-100">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-3 flex items-start md:items-center gap-3">
            <svg class="w-5 h-5 text-amber-600 flex-shrink-0 mt-0.5 md:mt-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
            </svg>
            <div class="text-sm text-amber-800">
                <span class="font-semibold">{% trans "Profilingiz tasdiqlanishi kutilmoqda." %}</span>
                {% trans "Administrator tasdiqlagandan so'ng barcha funksiyalar ochiladi." %}
            </div>
        </div>
    </div>
    {% endif %}

    <div class="py-8">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Left Column: Profile Info -->
                <div class="lg:col-span-1 space-y-6">
                    <!-- Profile Card -->
                    <div class="bg-[var(--surface)] rounded-2xl shadow-sm border border-[var(--border)] p-6 text-center">
                        <div class="relative w-32 h-32 mx-auto mb-4">
                            {% if profile.avatar %}
                            <img src="{{ profile.avatar.url }}" alt="Avatar" class="w-full h-full rounded-full object-cover border-4 border-white shadow-md">
                            {% else %}
                            <div class="w-full h-full rounded-full bg-primary-100 flex items-center justify-center text-[var(--accent)] text-4xl font-bold border-4 border-white shadow-md">
                                {{ request.user.get_username|first|upper|default:"U" }}
                            </div>
                            {% endif %}
                            <button onclick="document.getElementById('avatarInput').click()" class="absolute bottom-0 right-0 bg-[var(--surface)] p-2 rounded-full shadow-md border border-[var(--border)] hover:bg-[var(--bg)] transition-colors text-[var(--text-secondary)]">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" />
                                </svg>
                            </button>
                        </div>

                        <h1 class="text-xl font-bold text-[var(--text-primary)] mb-1 flex items-center justify-center gap-2">
                            {{ request.user.get_full_name|default:request.user.username }}
                            {% if profile.is_approved %}
                            <svg class="w-5 h-5 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" title="{% trans 'Tasdiqlangan foydalanuvchi' %}">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            {% endif %}
                        </h1>
                        <p class="text-sm text-[var(--text-secondary)] mb-4">
                            {{ request.user.email }}
                        </p>

                        <div class="flex flex-wrap justify-center gap-2 mb-6">
                            {% if profile.is_approved %}
                            <span class="px-3 py-1 bg-green-100 text-green-700 text-xs font-medium rounded-full">{% trans "Ishonchli sharhchi" %}</span>
                            {% endif %}
                            {% if profile_stats.total_reviews >= 50 %}
                            <span class="px-3 py-1 bg-primary-100 text-primary-700 text-xs font-medium rounded-full">{% trans "Mahalliy ekspert" %}</span>
                            {% endif %}
                        </div>

                        <!-- Stats Grid -->
                        <div class="grid grid-cols-2 gap-4 border-t border-[var(--border)] pt-4">
                            <div class="text-center">
                                <div class="text-xl font-bold text-[var(--text-primary)]">{{ profile_stats.total_reviews }}</div>
                                <div class="text-xs text-[var(--text-secondary)]">{% trans "Sharhlar" %}</div>
                            </div>
                            <div class="text-center">
                                <div class="text-xl font-bold text-[var(--text-primary)]">{{ profile_stats.helpful_votes }}</div>
                                <div class="text-xs text-[var(--text-secondary)]">{% trans "Foydali" %}</div>
                            </div>
                            <div class="text-center">
                                <div class="text-xl font-bold text-[var(--text-primary)]">{{ profile_stats.unique_companies }}</div>
                                <div class="text-xs text-[var(--text-secondary)]">{% trans "Bizneslar" %}</div>
                            </div>
                            <div class="text-center">
                                <div class="text-xl font-bold text-[var(--text-primary)]">{{ profile_stats.avg_rating|floatformat:1 }}</div>
                                <div class="text-xs text-[var(--text-secondary)]">{% trans "O'rtacha" %}</div>
                            </div>
                        </div>
                    </div>

                    <!-- Edit Profile Form -->
                    <div class="bg-[var(--surface)] rounded-2xl shadow-sm border border-[var(--border)] p-6">
                        <h2 class="text-lg font-semibold text-[var(--text-primary)] mb-4">{% trans "Profilni tahrirlash" %}</h2>
                        <form method="post" enctype="multipart/form-data" class="space-y-4" data-validate>
                            {% csrf_token %}
                            {% if form.errors %}
                                <div class="bg-red-50 text-red-600 p-3 rounded-lg text-sm">
                                    {{ form.non_field_errors }}
                                    {% for field in form %}
                                        {% if field.errors %}
                                            <div><strong>{{ field.label }}:</strong> {{ field.errors|striptags }}</div>
                                        {% endif %}
                                    {% endfor %}
                                </div>
                            {% endif %}
                            <input type="file" id="avatarInput" name="avatar" accept="image/*" class="hidden" onchange="this.form.submit()">

                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-[var(--text-primary)] mb-1">{% trans "Ism" %}</label>
                                    <input type="text" name="first_name" value="{{ form.first_name.value|default:'' }}" class="block w-full px-3 py-2 border border-[var(--border)] rounded-xl bg-[var(--bg)] focus:bg-[var(--surface)] focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-colors text-sm">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-[var(--text-primary)] mb-1">{% trans "Familiya" %}</label>
                                    <input type="text" name="last_name" value="{{ form.last_name.value|default:'' }}" class="block w-full px-3 py-2 border border-[var(--border)] rounded-xl bg-[var(--bg)] focus:bg-[var(--surface)] focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-colors text-sm">
                                </div>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-[var(--text-primary)] mb-1">{% trans "Bio" %}</label>
                                <textarea name="bio" rows="3" class="block w-full px-3 py-2 border border-[var(--border)] rounded-xl bg-[var(--bg)] focus:bg-[var(--surface)] focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-colors text-sm resize-none" placeholder="{% trans "O'zingiz haqingizda qisqacha..." %}">{{ form.bio.value|default:'' }}</textarea>
                            </div>

                            <button type="submit" class="w-full bg-[var(--accent)] hover:opacity-90 text-white font-medium py-2 px-4 rounded-xl transition-colors shadow-sm shadow-primary-200">
                                {% trans "Saqlash" %}
                            </button>
                        </form>
                    </div>
                </div>

                <!-- Right Column: Content -->
                <div class="lg:col-span-2 space-y-8">

                    <!-- Badges -->
                    <section>
                        <h2 class="text-lg font-bold text-[var(--text-primary)] mb-4">{% trans "Yutuqlar" %}</h2>
                        <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4">
                            <!-- Badge Item: 100+ Sharh -->
                            <div class="relative group bg-[var(--surface)] p-4 rounded-xl border border-[var(--border)] shadow-sm text-center hover:shadow-md transition-shadow {% if profile_stats.total_reviews < 100 %}grayscale opacity-60{% endif %}">
                                <div class="w-10 h-10 mx-auto bg-green-100 text-green-600 rounded-full flex items-center justify-center mb-2">
                                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>
                                </div>
                                <h3 class="text-sm font-semibold text-[var(--text-primary)]">{% trans "100+ Sharh" %}</h3>
                                <p class="text-xs text-[var(--text-secondary)]">{% trans "Faol sharhchi" %}</p>

                                {% if profile_stats.total_reviews < 100 %}
                                <div class="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 hidden group-hover:block w-48 bg-gray-900 text-white text-xs rounded py-1 px-2 z-10 shadow-lg">
                                    {% blocktrans with count=profile_stats.total_reviews %}100 ta sharhga yeting (Hozir: {{ count }}){% endblocktrans %}
                                    <div class="absolute top-full left-1/2 transform -translate-x-1/2 border-4 border-transparent border-t-gray-900"></div>
                                </div>
                                {% endif %}
                            </div>

                            <!-- Badge Item: Tasdiqlangan -->
                            <div class="relative group bg-[var(--surface)] p-4 rounded-xl border border-[var(--border)] shadow-sm text-center hover:shadow-md transition-shadow {% if not profile.is_approved %}grayscale opacity-60{% endif %}">
                                <div class="w-10 h-10 mx-auto bg-primary-100 text-[var(--accent)] rounded-full flex items-center justify-center mb-2">
                                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                                </div>
                                <h3 class="text-sm font-semibold text-[var(--text-primary)]">{% trans "Tasdiqlangan" %}</h3>
                                <p class="text-xs text-[var(--text-secondary)]">{% trans "Haqiqiy profil" %}</p>

                                {% if not profile.is_approved %}
                                <div class="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 hidden group-hover:block w-48 bg-gray-900 text-white text-xs rounded py-1 px-2 z-10 shadow-lg">
                                    {% trans "Admin tasdiqlashi kutilmoqda" %}
                                    <div class="absolute top-full left-1/2 transform -translate-x-1/2 border-4 border-transparent border-t-gray-900"></div>
                                </div>
                                {% endif %}
                            </div>

                            <!-- Badge Item: Foydali -->
                            <div class="relative group bg-[var(--surface)] p-4 rounded-xl border border-[var(--border)] shadow-sm text-center hover:shadow-md transition-shadow {% if profile_stats.helpful_votes < 1000 %}grayscale opacity-60{% endif %}">
                                <div class="w-10 h-10 mx-auto bg-purple-100 text-purple-600 rounded-full flex items-center justify-center mb-2">
                                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>
                                </div>
                                <h3 class="text-sm font-semibold text-[var(--text-primary)]">{% trans "Foydali" %}</h3>
                                <p class="text-xs text-[var(--text-secondary)]">{% trans "1000+ ovoz" %}</p>

                                {% if profile_stats.helpful_votes < 1000 %}
                                <div class="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 hidden group-hover:block w-48 bg-gray-900 text-white text-xs rounded py-1 px-2 z-10 shadow-lg">
                                    {% blocktrans with count=profile_stats.helpful_votes %}1000 ta foydali ovoz to'plang (Hozir: {{ count }}){% endblocktrans %}
                                    <div class="absolute top-full left-1/2 transform -translate-x-1/2 border-4 border-transparent border-t-gray-900"></div>
                                </div>
                                {% endif %}
                            </div>

                            <!-- Badge Item: Ekspert -->
                            <div class="relative group bg-[var(--surface)] p-4 rounded-xl border border-[var(--border)] shadow-sm text-center hover:shadow-md transition-shadow {% if profile_stats.total_reviews < 50 %}grayscale opacity-60{% endif %}">
                                <div class="w-10 h-10 mx-auto bg-amber-100 text-amber-600 rounded-full flex items-center justify-center mb-2">
                                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>
                                </div>
                                <h3 class="text-sm font-semibold text-[var(--text-primary)]">{% trans "Ekspert" %}</h3>
                                <p class="text-xs text-[var(--text-secondary)]">{% trans "Top sharhchi" %}</p>

                                {% if profile_stats.total_reviews < 50 %}
                                <div class="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 hidden group-hover:block w-48 bg-gray-900 text-white text-xs rounded py-1 px-2 z-10 shadow-lg">
                                    {% blocktrans with count=profile_stats.total_reviews %}50 ta sharhga yeting (Hozir: {{ count }}){% endblocktrans %}
                                    <div class="absolute top-full left-1/2 transform -translate-x-1/2 border-4 border-transparent border-t-gray-900"></div>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </section>

                    <!-- Reviews Tab -->
                    <section>
                        <div class="flex items-center justify-between mb-4">
                            <h2 class="text-lg font-bold text-[var(--text-primary)]">{% trans "Sharhlarim" %}</h2>
                            <div class="flex space-x-2">
                                <button class="px-3 py-1 text-sm font-medium text-[var(--accent)] bg-primary-50 rounded-lg">{% trans "Barchasi" %}</button>
                                <button class="px-3 py-1 text-sm font-medium text-[var(--text-secondary)] hover:bg-[var(--surface)] rounded-lg transition-colors">{% trans "Saqlangan" %}</button>
                            </div>
                        </div>

                        <div class="space-y-4">
                            {% for r in user_reviews %}
                            <div class="bg-[var(--surface)] rounded-2xl shadow-sm border border-[var(--border)] p-5 hover:shadow-md transition-shadow">
                                <div class="flex items-start justify-between mb-3">
                                    <div class="flex items-center gap-3">
                                        <img src="{{ r.company.display_image_url|default:r.company.image_url|default:'https://via.placeholder.com/100' }}"
                                             alt="{{ r.company.name }}"
                                             class="w-10 h-10 rounded-lg object-cover bg-[var(--surface)]">
                                        <div>
                                            <a href="{% url 'company_detail' r.company.pk %}" class="font-semibold text-[var(--text-primary)] hover:text-[var(--accent)] transition-colors">
                                                {{ r.company.name }}
                                            </a>
                                            <div class="text-xs text-[var(--text-secondary)]">{{ r.created_at|date:"d M, Y" }}</div>
                                        </div>
                                    </div>
                                    <div class="flex items-center gap-1">
                                        {% for i in "12345" %}
                                            {% if r.rating >= i|add:0 %}
                                                <svg class="w-4 h-4 text-yellow-400" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/></svg>
                                            {% else %}
                                                <svg class="w-4 h-4 text-gray-200" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/></svg>
                                            {% endif %}
                                        {% endfor %}
                                    </div>
                                </div>

                                <p class="text-[var(--text-primary)] text-sm mb-4">{{ r.text }}</p>

                                <div class="flex items-center justify-end gap-3 text-xs font-medium">
                                    <a href="{% url 'review_edit' r.pk %}" class="text-[var(--text-secondary)] hover:text-[var(--accent)] flex items-center gap-1 transition-colors">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg>
                                        {% trans "Tahrirlash" %}
                                    </a>
                                    <a href="{% url 'review_delete' r.pk %}" class="text-red-500 hover:text-red-600 flex items-center gap-1 transition-colors">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                                        {% trans "O'chirish" %}
                                    </a>
                                </div>
                            </div>
                            {% empty %}
                            <div class="text-center py-12 bg-[var(--surface)] rounded-2xl border border-dashed border-[var(--border)]">
                                <div class="text-gray-400 mb-2">
                                    <svg class="w-12 h-12 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/></svg>
                                </div>
                                <h3 class="text-lg font-medium text-[var(--text-primary)]">{% trans "Hozircha sharhlar yo'q" %}</h3>
                                <p class="text-[var(--text-secondary)]">{% trans "Birinchi sharhingizni yozing!" %}</p>
                                <a href="{% url 'review_submission' %}" class="inline-block mt-4 text-[var(--accent)] font-medium hover:underline">{% trans "Sharh yozish &rarr;" %}</a>
                            </div>
                            {% endfor %}
                        </div>

                        {% if user_reviews.has_other_pages %}
                        <div class="mt-6 flex justify-center">
                            <a href="?page={{ user_reviews.next_page_number }}" class="px-4 py-2 bg-[var(--surface)] border border-[var(--border)] rounded-lg text-[var(--text-secondary)] hover:bg-[var(--bg)] transition-colors shadow-sm">
                                {% trans "Ko'proq yuklash" %}
                            </a>
                        </div>
                        {% endif %}
                    </section>
                </div>
            </div>
        </div>
    </div>
{% endblock %}
