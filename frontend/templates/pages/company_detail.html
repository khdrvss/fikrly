{% extends 'base.html' %}
{% load static %}
{% load static_bust %}
{% load i18n %}
{% load company_tags %}

{% block title %}{{ company.name }} sharhlar va reyting | Fikrly.uz{% endblock %}

{% block meta_description %}{{ company.name }} haqida haqiqiy foydalanuvchi sharhlari va reytinglari. Xizmat sifati, afzalliklari va kamchiliklari — bularning barchasi Fikrly.uz platformasida.{% endblock %}

{% block extra_head %}
    <meta property="og:type" content="business.business" />
    <meta property="og:title" content="{{ company.name }} sharhlar va reyting | Fikrly.uz" />
    <meta property="og:description" content="{{ company.name }} haqida haqiqiy foydalanuvchi sharhlari va reytinglari. Xizmat sifati, afzalliklari va kamchiliklari — bularning barchasi Fikrly.uz platformasida." />
    <meta property="og:image" content="{{ company.display_image_url|default:company.image_url }}" />

    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="{{ company.name }} sharhlar va reyting | Fikrly.uz" />
    <meta name="twitter:description" content="{{ company.name }} haqida haqiqiy foydalanuvchi sharhlari va reytinglari. Xizmat sifati, afzalliklari va kamchiliklari — bularning barchasi Fikrly.uz platformasida." />
    <meta name="twitter:image" content="{{ company.display_image_url|default:company.image_url }}" />
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "BreadcrumbList",
      "itemListElement": [{
        "@type": "ListItem",
        "position": 1,
        "name": "{% trans 'Bosh sahifa' %}",
        "item": "{{ request.scheme }}://{{ request.get_host }}{% url 'index' %}"
      },{
        "@type": "ListItem",
        "position": 2,
        "name": "{% trans 'Bizneslar' %}",
        "item": "{{ request.scheme }}://{{ request.get_host }}{% url 'business_list' %}"
      },{
        "@type": "ListItem",
        "position": 3,
        "name": "{{ company.name }}",
        "item": "{{ request.build_absolute_uri }}"
      }]
    }
    </script>
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "LocalBusiness",
      "name": "{{ company.name }}",
      "image": "{{ company.display_image_url|default:company.image_url }}",
      "@id": "{{ request.build_absolute_uri }}",
      "url": "{{ request.build_absolute_uri }}",
      "telephone": "{{ company.phone_public }}",
      "email": "{{ company.email_public }}",
      "address": {
        "@type": "PostalAddress",
        "streetAddress": "{{ company.address }}",
        "addressLocality": "{{ company.city|default:'Tashkent' }}",
        "addressCountry": "UZ"
      },
      "aggregateRating": {
        "@type": "AggregateRating",
        "ratingValue": "{{ company.rating }}",
        "reviewCount": "{{ company.review_count }}",
        "bestRating": "5",
        "worstRating": "1"
      }
    }
    </script>
{% endblock %}

{% block content %}
    <!-- Hero Section -->
    <div class="relative bg-white pb-12">
        <!-- Cover Image -->
        <div class="h-48 md:h-80 w-full overflow-hidden bg-gray-200 relative">
            <!-- Breadcrumbs Overlay -->
            <div class="absolute top-0 left-0 w-full z-20 pt-4">
                <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                    <nav class="flex" aria-label="Breadcrumb">
                        <ol class="inline-flex items-center space-x-1 md:space-x-3 bg-black/20 backdrop-blur-sm px-4 py-2 rounded-full">
                            <li class="inline-flex items-center">
                                <a href="{% url 'index' %}" class="inline-flex items-center text-sm font-medium text-white hover:text-white/80">
                                    <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20"><path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"></path></svg>
                                    {% trans "Bosh sahifa" %}
                                </a>
                            </li>
                            <li>
                                <div class="flex items-center">
                                    <svg class="w-6 h-6 text-white/60" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path></svg>
                                    <a href="{% url 'category_browse' %}" class="ml-1 text-sm font-medium text-white hover:text-white/80 md:ml-2">{% trans "Kategoriyalar" %}</a>
                                </div>
                            </li>
                            {% if company.category_fk %}
                            <li>
                                <div class="flex items-center">
                                    <svg class="w-6 h-6 text-white/60" aria-hidden="true" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path></svg>
                                    <a href="{% url 'business_list_by_category' category_slug=company.category_fk.slug %}" class="ml-1 text-sm font-medium text-white hover:text-white/80 md:ml-2">{{ company.category_fk.display_name }}</a>
                                </div>
                            </li>
                            {% endif %}
                            <li aria-current="page">
                                <div class="flex items-center">
                                    <svg class="w-6 h-6 text-white/60" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path></svg>
                                    <span class="ml-1 text-sm font-medium text-white/90 md:ml-2">{{ company.name }}</span>
                                </div>
                            </li>
                        </ol>
                    </nav>
                </div>
            </div>

            <!-- TODO: Change default company cover image here. Recommended size: 1600x800px -->
            {% static 'images/placeholder.png' as default_cover %}
            <img src="{{ company.display_image_url|default:company.image_url|default:default_cover }}"
                 alt="{{ company.name }} cover"
                 data-lightbox="{{ company.display_image_url|default:company.image_url|default:default_cover }}"
                 class="w-full h-full object-cover cursor-pointer hover:opacity-95 transition-opacity"
                 onerror="this.src='{{ default_cover }}'">
            <div class="hidden md:block absolute inset-0 bg-gradient-to-t from-black/50 to-transparent pointer-events-none"></div>
        </div>

        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 relative">
            <div class="flex flex-col md:flex-row items-start md:items-end -mt-16 md:-mt-20 mb-6 gap-6">
                <!-- Logo -->
                <div class="relative z-10 bg-white p-1 rounded-2xl shadow-lg overflow-hidden">
                    <div class="w-32 h-32 md:w-40 md:h-40 rounded-xl overflow-hidden relative bg-gray-50">
                        {% if company.display_logo %}
                        <img src="{{ company.display_logo }}"
                             alt="{{ company.name }} logo"
                             class="w-full h-full object-cover absolute inset-0"
                             style="transform: scale(calc({{ company.logo_scale|default:100 }} / 100));"
                             onerror="this.onerror=null;this.src='https://api.dicebear.com/7.x/shapes/svg?seed={{ company.name|urlencode }}&backgroundColor=b6e3f4,c0aede,d1d4f9&backgroundType=gradientLinear';">
                        {% else %}
                        <img src="https://api.dicebear.com/7.x/shapes/svg?seed={{ company.name|urlencode }}&backgroundColor=b6e3f4,c0aede,d1d4f9&backgroundType=gradientLinear"
                             alt="{{ company.name }} logo"
                             class="w-full h-full object-cover">
                        {% endif %}
                    </div>
                </div>

                <!-- Title & Meta -->
                <div class="flex-1 text-gray-900 md:mb-2 z-10 md:z-auto">
                    <h1 class="text-3xl md:text-4xl font-bold flex items-center gap-2">
                        {{ company.name }}
                        {% if company.is_verified %}
                            <svg class="w-8 h-8 text-green-500 bg-white rounded-full p-0.5" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                            </svg>
                        {% endif %}
                    </h1>
                    <div class="flex flex-wrap items-center gap-3 mt-2 text-sm md:text-base font-medium text-gray-600">
                        {% with cat=company.category_fk %}
                        <span class="px-3 py-1 rounded-full
                            {% if cat.color == 'red' %}bg-red-50 text-red-600
                            {% elif cat.color == 'orange' %}bg-orange-50 text-orange-600
                            {% elif cat.color == 'yellow' %}bg-yellow-50 text-yellow-600
                            {% elif cat.color == 'green' %}bg-green-50 text-green-600
                            {% elif cat.color == 'blue' %}bg-primary-50 text-primary-600
                            {% elif cat.color == 'purple' %}bg-purple-50 text-purple-600
                            {% elif cat.color == 'pink' %}bg-pink-50 text-pink-600
                            {% else %}bg-gray-100 text-gray-600{% endif %}">
                            {{ cat.display_name|default:company.category }}
                        </span>
                        {% endwith %}
                        {% if company.city %}
                            <span class="flex items-center gap-1">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                                {{ company.city }}
                            </span>
                        {% endif %}
                        {% if years_on_site %}
                            <span>• {% blocktrans with years=years_on_site %}{{ years }} yil saytda{% endblocktrans %}</span>
                        {% endif %}
                    </div>

                </div>

                <!-- Action Buttons -->
                <div class="flex gap-3 md:w-auto mt-4 md:mt-0 md:mb-2">
                    <a href="{% url 'review_submission' %}?company={{ company.pk }}" class="btn-primary px-4 py-2 md:px-6 md:py-3 rounded-xl shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 transition-all flex items-center justify-center gap-2 font-semibold text-sm md:text-base">
                        <svg class="w-4 h-4 md:w-5 md:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                        {% trans "Sharh yozish" %}
                    </a>
                    <button id="likeBtn" class="btn-outline px-3 py-2 md:px-4 md:py-3 rounded-xl border-gray-300 hover:border-gray-400 hover:text-gray-600 hover:bg-gray-50 transition-colors flex items-center gap-2 bg-white text-sm md:text-base"
                            data-auth="{% if request.user.is_authenticated %}1{% else %}0{% endif %}"
                            data-liked="{% if liked_state %}1{% else %}0{% endif %}"
                            data-like-url="{% url 'like_company' company.pk %}"
                            {% if not request.user.is_authenticated %}onclick="window.location='{% url 'account_login' %}?next={{ request.path }}'"{% endif %}>
                        <svg id="likeIcon" class="w-5 h-5 md:w-6 md:h-6" fill="{% if liked_state %}currentColor{% else %}none{% endif %}" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path></svg>
                        <span id="likeCount" class="font-medium">{{ company.like_count }}</span>
                    </button>
                    <button data-copy="{{ request.build_absolute_uri }}"
                            data-copy-message="Kompaniya havolasi nusxalandi!"
                            data-tooltip="Havolani ulashish"
                            class="btn-outline px-3 py-2 md:px-4 md:py-3 rounded-xl border-gray-300 hover:border-gray-400 hover:text-gray-600 hover:bg-gray-50 transition-colors flex items-center gap-2 bg-white text-sm md:text-base">
                        <svg class="w-5 h-5 md:w-6 md:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"/>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 mt-8 pb-20">
        <div class="grid lg:grid-cols-3 gap-8">
            <!-- Left Column: Main Content -->
            <div class="lg:col-span-2 space-y-8">

                <!-- About Section -->
                {% if company.display_description or company.website or company.facebook_url or company.instagram_url or company.telegram_url %}
                <section class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100 mb-8">
                    <h2 class="text-lg font-bold text-gray-900 mb-3">{% trans "Kompaniya haqida" %}</h2>
                    {% if company.display_description %}
                    <p class="text-gray-600 leading-relaxed">{{ company.display_description }}</p>
                    {% endif %}

                    <div class="mt-6 flex flex-wrap gap-3">
                        {% if company.website %}
                            <a href="{{ company.website }}" target="_blank" rel="noopener" class="inline-flex items-center gap-2 px-4 py-2 bg-gray-50 hover:bg-gray-100 rounded-lg text-primary-600 transition-colors text-sm font-medium">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9"></path></svg>
                                {% trans "Veb-saytga o'tish" %}
                            </a>
                        {% endif %}
                        {% if company.facebook_url %}
                            <a href="{{ company.facebook_url }}" target="_blank" rel="noopener" class="inline-flex items-center gap-2 px-4 py-2 bg-primary-50 hover:bg-primary-100 text-primary-700 rounded-lg transition-colors text-sm font-medium">
                                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M22 12a10 10 0 1 0-11.6 9.87v-6.99H7.9V12h2.5V9.79c0-2.46 1.47-3.82 3.72-3.82 1.08 0 2.2.19 2.2.19v2.42h-1.24c-1.22 0-1.6.76-1.6 1.54V12h2.72l-.43 2.88h-2.29v6.99A10 10 0 0 0 22 12Z"/></svg>
                                Facebook
                            </a>
                        {% endif %}
                        {% if company.instagram_url %}
                            <a href="{{ company.instagram_url }}" target="_blank" rel="noopener" class="inline-flex items-center gap-2 px-4 py-2 bg-pink-50 hover:bg-pink-100 text-pink-700 rounded-lg transition-colors text-sm font-medium">
                                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M7 2h10a5 5 0 0 1 5 5v10a5 5 0 0 1-5 5H7a5 5 0 0 1-5-5V7a5 5 0 0 1 5-5zm5 5a5 5 0 1 0 0 10 5 5 0 0 0 0-10zm6.5-.75a1.25 1.25 0 1 0 0 2.5 1.25 1.25 0 0 0 0-2.5z"/></svg>
                                Instagram
                            </a>
                        {% endif %}
                        {% if company.telegram_url %}
                            <a href="{{ company.telegram_url }}" target="_blank" rel="noopener" class="inline-flex items-center gap-2 px-4 py-2 bg-sky-50 hover:bg-sky-100 text-sky-600 rounded-lg transition-colors text-sm font-medium">
                                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M9.9 14.2l-.4 5.6c.6 0 .9-.3 1.2-.7l2.9-2.8 6.1 4.5c1.1.6 1.8.3 2.1-1l3.8-17.7c.4-1.7-.6-2.4-1.7-2l-22.4 8.6c-1.5.6-1.5 1.4-.3 1.8l5.7 1.8L19 6.1c.8-.5 1.6-.2 1 0l-10.1 8.1z"/></svg>
                                Telegram
                            </a>
                        {% endif %}
                    </div>
                </section>
                {% endif %}

                <!-- Rating Overview -->
                <section class="bg-white rounded-2xl p-6 shadow-sm border border-green-200">
                    <div class="flex flex-col md:flex-row gap-8 items-center">
                        <div class="text-center md:text-left">
                            <div class="text-5xl font-bold text-gray-900">{{ company.rating }}</div>
                            <div class="flex items-center justify-center md:justify-start gap-1 my-2">
                                {% for i in "12345" %}
                                    {% if company.rating >= i|add:0 %}
                                        <svg class="w-6 h-6 text-yellow-400" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/></svg>
                                    {% else %}
                                        <svg class="w-6 h-6 text-gray-200" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/></svg>
                                    {% endif %}
                                {% endfor %}
                            </div>
                            <div class="text-sm text-gray-500 font-medium">{% blocktrans with count=company.review_count %}{{ count }} ta sharh asosida{% endblocktrans %}</div>
                        </div>

                        <div class="flex-1 w-full space-y-2">
                            {% for row in rating_distribution %}
                            <a href="?{{ qs_no_stars }}stars={{ row.star }}" class="flex items-center gap-3 group">
                                <span class="text-sm font-medium text-gray-600 w-3">{{ row.star }}</span>
                                <svg class="w-4 h-4 text-gray-300" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/></svg>
                                <div class="flex-1 h-2 bg-gray-100 rounded-full overflow-hidden">
                                    <div class="h-full bg-yellow-400 rounded-full transition-all duration-500 group-hover:bg-yellow-500" style="width: {{ row.percent }}%"></div>
                                </div>
                                <span class="text-xs text-gray-400 w-8 text-right">{{ row.percent }}%</span>
                            </a>
                            {% endfor %}
                        </div>
                    </div>
                </section>

                <!-- Reviews List -->
                <section id="reviews">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-xl font-bold text-gray-900">{% trans "Sharhlar" %}</h2>

                        <!-- Filter Dropdown -->
                        <div class="relative inline-block text-left">
                            <form method="get" class="flex items-center gap-2">
                                <select name="sort" class="form-select text-sm border-gray-200 rounded-lg focus:ring-primary-500 focus:border-primary-500" onchange="this.form.submit()">
                                    <option value="most_liked" {% if current_sort == 'most_liked' %}selected{% endif %}>{% trans "Eng ko'p layk" %}</option>
                                    <option value="newest" {% if current_sort == 'newest' %}selected{% endif %}>{% trans "Eng yangi" %}</option>
                                    <option value="highest" {% if current_sort == 'highest' %}selected{% endif %}>{% trans "Yuqori baho" %}</option>
                                    <option value="lowest" {% if current_sort == 'lowest' %}selected{% endif %}>{% trans "Past baho" %}</option>
                                </select>
                                {% for key, val in request.GET.items %}
                                    {% if key != 'sort' and key != 'page' %}
                                        <input type="hidden" name="{{ key }}" value="{{ val }}" />
                                    {% endif %}
                                {% endfor %}
                            </form>
                        </div>
                    </div>

                    <div class="space-y-6">
                        {% for r in reviews %}
                        <article class="bg-white rounded-2xl p-6 shadow-sm border border-green-200 transition-shadow hover:shadow-md">
                            <div class="flex items-start justify-between mb-4">
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 rounded-full bg-gradient-to-br from-primary-100 to-primary-50 flex items-center justify-center text-primary-600 font-bold text-lg">
                                        {{ r.user_name|slice:":1"|upper }}
                                    </div>
                                    <div>
                                        <div class="flex items-center gap-2">
                                            {% if r.user %}
                                                <a href="{% url 'public_profile' r.user.username %}" class="font-semibold text-gray-900 hover:text-primary-600 hover:underline transition-colors">
                                                    {{ r.user_name }}
                                                </a>
                                            {% else %}
                                                <div class="font-semibold text-gray-900">{{ r.user_name }}</div>
                                            {% endif %}

                                            {% if r.verified_purchase %}
                                            <div class="flex items-center gap-1 text-green-600 bg-green-50 px-2 py-0.5 rounded-full text-xs font-medium border border-green-100" title="{% trans 'Foydalanuvchi xarid chekini taqdim etgan' %}">
                                                <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg>
                                                {% trans "Tasdiqlangan xarid" %}
                                            </div>
                                            {% endif %}
                                        </div>
                                        <div class="text-xs text-gray-500">{{ r.created_at|date:"d M, Y" }}</div>
                                    </div>
                                </div>
                                <div class="flex items-center gap-1 bg-gray-50 px-2 py-1 rounded-lg">
                                    <span class="font-bold text-gray-900">{{ r.rating }}</span>
                                    <svg class="w-4 h-4 text-yellow-400" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/></svg>
                                </div>
                            </div>

                            <p class="text-gray-700 leading-relaxed">{{ r.text }}</p>

                            {% if r.owner_response_text %}
                            <div class="mt-4 pl-4 border-l-4 border-primary-100 bg-primary-50/50 p-4 rounded-r-lg">
                                <div class="flex items-center gap-2 mb-2">
                                    <span class="text-xs font-bold text-primary-600 uppercase tracking-wider">{% trans "Biznes javobi" %}</span>
                                    <span class="text-xs text-gray-400">• {{ r.owner_response_at|date:"d M, Y" }}</span>
                                </div>
                                <p class="text-gray-600 text-sm">{{ r.owner_response_text }}</p>
                            </div>
                            {% endif %}

                            <div class="mt-4 flex items-center justify-between text-sm">
                                <button class="review-like-btn flex items-center gap-1 text-gray-500 hover:text-red-500 transition-colors {% if r.is_liked_by_user %}text-red-500{% endif %}"
                                        data-review-id="{{ r.pk }}"
                                        data-like-url="{% url 'like_review' r.pk %}"
                                        {% if not request.user.is_authenticated %}onclick="window.location='{% url 'account_login' %}?next={{ request.path }}'; return false;"{% endif %}>
                                    <svg class="w-5 h-5" fill="{% if r.is_liked_by_user %}currentColor{% else %}none{% endif %}" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path></svg>
                                    <span class="like-count font-medium">{{ r.like_count }}</span>
                                </button>

                                <a href="{% url 'report_review' r.pk %}" class="text-gray-400 hover:text-red-500 transition-colors flex items-center gap-1">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>
                                    {% trans "Shikoyat" %}
                                </a>
                            </div>
                        </article>
                        {% empty %}
                        <div class="text-center py-12 bg-white rounded-2xl border border-dashed border-gray-200">
                            <div class="text-gray-400 mb-2">
                                <svg class="w-12 h-12 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/></svg>
                            </div>
                            <h3 class="text-lg font-medium text-gray-900">{% trans "Hozircha sharhlar yo'q" %}</h3>
                            <p class="text-gray-500">{% trans "Birinchi bo'lib o'z fikringizni qoldiring!" %}</p>
                            <a href="{% url 'review_submission' %}?company={{ company.pk }}" class="inline-block mt-4 text-primary-600 font-medium hover:underline">{% trans "Sharh yozish" %} &rarr;</a>
                        </div>
                        {% endfor %}
                    </div>

                    <!-- Pagination -->
                    {% if reviews.has_other_pages %}
                    {% load url_params %}
                    <div class="mt-12 flex justify-center">
                        <nav class="flex items-center space-x-2" aria-label="Pagination">
                            {% if reviews.has_previous %}
                                <a href="?{% url_replace request 'page' reviews.previous_page_number %}" class="p-2 rounded-lg border border-gray-200 text-gray-500 hover:bg-gray-50 hover:text-primary-600 transition-colors">
                                    <span class="sr-only">{% trans "Oldingi" %}</span>
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                                </a>
                            {% else %}
                                <span class="p-2 rounded-lg border border-gray-100 text-gray-300 cursor-not-allowed">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                                </span>
                            {% endif %}

                            {% for i in reviews.paginator.page_range %}
                                {% if reviews.number == i %}
                                    <span class="px-4 py-2 rounded-lg bg-primary-600 text-white font-medium shadow-sm">{{ i }}</span>
                                {% elif i > reviews.number|add:'-3' and i < reviews.number|add:'3' %}
                                    <a href="?{% url_replace request 'page' i %}" class="px-4 py-2 rounded-lg border border-gray-200 text-gray-700 hover:bg-gray-50 hover:text-primary-600 transition-colors">{{ i }}</a>
                                {% endif %}
                            {% endfor %}

                            {% if reviews.has_next %}
                                <a href="?{% url_replace request 'page' reviews.next_page_number %}" class="p-2 rounded-lg border border-gray-200 text-gray-500 hover:bg-gray-50 hover:text-primary-600 transition-colors">
                                    <span class="sr-only">{% trans "Keyingi" %}</span>
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                                </a>
                            {% else %}
                                <span class="p-2 rounded-lg border border-gray-100 text-gray-300 cursor-not-allowed">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                                </span>
                            {% endif %}
                        </nav>
                    </div>
                    {% endif %}
                </section>


            </div>

            <!-- Right Column: Sidebar -->
            <aside class="space-y-6">
                <!-- Contact Info Card -->
                <div class="bg-white rounded-2xl p-6 shadow-sm border border-green-200">
                    <h3 class="text-lg font-bold text-gray-900 mb-4">{% trans "Bog'lanish" %}</h3>
                    <div class="space-y-4">
                        {% if company.address %}
                        <div class="flex items-start gap-3">
                            <div class="w-8 h-8 rounded-full bg-gray-50 flex items-center justify-center flex-shrink-0 text-gray-400">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                            </div>
                            <div>
                                <div class="text-xs font-medium text-gray-500 uppercase tracking-wide">{% trans "Manzil" %}</div>
                                <div class="text-gray-900">{{ company.address }}</div>
                                {% if map_url %}
                                    <a href="{{ map_url }}" target="_blank" class="text-sm text-primary-600 hover:underline mt-1 inline-block">{% trans "Xaritada ko'rish" %}</a>
                                {% endif %}
                            </div>
                        </div>
                        {% endif %}

                        {% if company.phone_public %}
                        <div class="flex items-start gap-3">
                            <div class="w-8 h-8 rounded-full bg-gray-50 flex items-center justify-center flex-shrink-0 text-gray-400">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path></svg>
                            </div>
                            <div class="w-full">
                                <div class="text-xs font-medium text-gray-500 uppercase tracking-wide">{% trans "Telefon" %}</div>
                                {% if request.user.is_authenticated %}
                                    <button id="revealPhone" data-url="{% url 'reveal_contact' company.pk 'phone' %}" class="text-primary-600 hover:underline font-medium">{% trans "Raqamni ko'rsatish" %}</button>
                                {% else %}
                                    <a href="{% url 'account_login' %}?next={{ request.path }}" class="text-primary-600 hover:underline font-medium">{% trans "Raqamni ko'rsatish" %}</a>
                                {% endif %}
                            </div>
                        </div>
                        {% endif %}

                        {% if company.email_public %}
                        <div class="flex items-start gap-3">
                            <div class="w-8 h-8 rounded-full bg-gray-50 flex items-center justify-center flex-shrink-0 text-gray-400">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>
                            </div>
                            <div class="w-full">
                                <div class="text-xs font-medium text-gray-500 uppercase tracking-wide">{% trans "Email" %}</div>
                                {% if request.user.is_authenticated %}
                                    <button id="revealEmail" data-url="{% url 'reveal_contact' company.pk 'email' %}" class="text-primary-600 hover:underline font-medium">{% trans "Emailni ko'rsatish" %}</button>
                                {% else %}
                                    <a href="{% url 'account_login' %}?next={{ request.path }}" class="text-primary-600 hover:underline font-medium">{% trans "Emailni ko'rsatish" %}</a>
                                {% endif %}
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Working Hours -->
                {% if company.working_hours %}
                {% is_open_now company.working_hours as status %}
                <div class="bg-white rounded-2xl p-6 shadow-sm border border-green-200">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-bold text-gray-900">{% trans "Ish vaqti" %}</h3>
                        <span class="px-2.5 py-0.5 rounded-full text-xs font-medium {% if status.status %}bg-green-100 text-green-800{% else %}bg-red-100 text-red-800{% endif %}">
                            {{ status.text }}
                        </span>
                    </div>
                    <div class="space-y-3">
                        {% for item in company.working_hours|format_working_hours %}
                        <div class="flex justify-between text-sm {% if item.is_today %}font-bold text-gray-900{% else %}text-gray-600{% endif %}">
                            <span>{{ item.day }}</span>
                            <span>{{ item.hours }}</span>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}



                {% if not company.manager %}
                <div class="bg-gradient-to-br from-gray-900 to-gray-800 rounded-2xl p-6 text-white shadow-lg">
                    <h3 class="font-bold text-lg mb-2">{% trans "Bu sizning biznesingizmi?" %}</h3>
                    <p class="text-gray-300 text-sm mb-4">{% trans "Kompaniyani tasdiqlang va ma'lumotlarni boshqaring." %}</p>
                    <a href="{% if request.user.is_authenticated %}{% url 'claim_company' company.pk %}{% else %}{% url 'account_login' %}?next={% url 'claim_company' company.pk %}{% endif %}"
                       class="block w-full py-2 bg-white text-gray-900 text-center rounded-lg font-semibold hover:bg-gray-100 transition-colors">
                        {% trans "Kompaniyani tasdiqlash" %}
                    </a>
                </div>
                {% endif %}
                <!-- Verification Info Card -->
                <div class="bg-primary-50 rounded-2xl p-6 border border-primary-100">
                    <h3 class="text-sm font-bold text-primary-900 mb-2 flex items-center gap-2">
                        <svg class="w-5 h-5 text-primary-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                        {% trans "Xaridingizni tasdiqlang" %}
                    </h3>
                    <p class="text-sm text-primary-800 mb-3">
                        {% trans "Sharh yozishda xarid chekini yuklang va 'Tasdiqlangan xarid' belgisiga ega bo'ling." %}
                    </p>
                    <a href="{% url 'review_submission' %}?company={{ company.pk }}" class="inline-flex items-center gap-2 text-sm font-medium text-white bg-primary-600 hover:bg-primary-700 px-4 py-2 rounded-lg transition-colors w-full justify-center">
                        {% trans "Sharh yozish" %}
                    </a>
                </div>

            </aside>
        </div>

        <!-- Similar Companies -->
        {% if similar_companies %}
        <section class="mt-12 border-t border-gray-100 pt-12">
            <h2 class="text-xl font-bold text-gray-900 mb-6">{% trans "O'xshash kompaniyalar" %}</h2>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                {% for c in similar_companies %}
                <a href="{% url 'company_detail' c.pk %}" class="bg-white rounded-xl p-4 shadow-sm border border-gray-100 hover:shadow-md transition-all group">
                    <div class="flex items-center gap-3 mb-3">
                        {% if c.display_logo %}
                            <img src="{{ c.display_logo }}" alt="{{ c.name }}" class="w-12 h-12 rounded-lg object-cover border border-gray-100">
                        {% else %}
                            <div class="w-12 h-12 rounded-lg bg-gray-100 flex items-center justify-center text-gray-400">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/></svg>
                            </div>
                        {% endif %}
                        <div>
                            <h3 class="font-semibold text-gray-900 group-hover:text-primary-600 line-clamp-1">{{ c.name }}</h3>
                            <div class="flex items-center text-xs text-gray-500">
                                <svg class="w-3 h-3 text-yellow-400 mr-1" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/></svg>
                                <span class="font-medium text-gray-900">{{ c.rating }}</span>
                                <span class="mx-1">•</span>
                                <span>{{ c.review_count }}</span>
                            </div>
                        </div>
                    </div>
                    <p class="text-xs text-gray-500 line-clamp-2">{{ c.display_description|default:c.category }}</p>
                </a>
                {% endfor %}
            </div>
        </section>
        {% endif %}
    </div>
{% endblock %}

{% block extra_js %}
    <script>
        // Like & Reveal Logic
        (function(){
            function getCookie(name){
                const value = `; ${document.cookie}`;
                const parts = value.split(`; ${name}=`);
                if (parts.length === 2) return parts.pop().split(';').shift();
            }

            // Like Button
            const likeBtn = document.getElementById('likeBtn');
            if (likeBtn && likeBtn.dataset.auth === '1'){
                likeBtn.addEventListener('click', function(){
                    const url = likeBtn.dataset.likeUrl;
                    fetch(url, {method:'POST', headers:{'X-CSRFToken': getCookie('csrftoken')}})
                    .then(r=>r.json())
                    .then(d=>{
                        if(d.ok){
                            document.getElementById('likeCount').textContent = d.like_count;
                            const icon = document.getElementById('likeIcon');
                            if(d.liked) {
                                icon.setAttribute('fill', 'currentColor');
                                likeBtn.classList.add('text-red-500', 'border-red-500');
                            } else {
                                icon.setAttribute('fill', 'none');
                                likeBtn.classList.remove('text-red-500', 'border-red-500');
                            }
                        }
                    });
                });
            }

            // Reveal Contact
            ['revealEmail', 'revealPhone'].forEach(id => {
                const btn = document.getElementById(id);
                if(btn){
                    btn.addEventListener('click', function(){
                        const url = btn.dataset.url;
                        fetch(url, {headers:{'X-CSRFToken': getCookie('csrftoken')}})
                        .then(r=>r.json())
                        .then(d=>{
                            if(d.ok){
                                const type = id === 'revealEmail' ? 'mailto:' : 'tel:';
                                btn.outerHTML = `<a href="${type}${d.value}" class="text-gray-900 font-medium hover:underline">${d.value}</a>`;
                            }
                        });
                    });
                }
            });

            // Review Like Buttons
            document.querySelectorAll('.review-like-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    if (this.hasAttribute('onclick')) return;
                    e.preventDefault();
                    const url = this.dataset.likeUrl;
                    const countSpan = this.querySelector('.like-count');
                    const icon = this.querySelector('svg');

                    fetch(url, {method:'POST', headers:{'X-CSRFToken': getCookie('csrftoken')}})
                        .then(res => res.json())
                        .then(data => {
                            if (data.ok) {
                                countSpan.textContent = data.like_count;
                                if (data.liked) {
                                    this.classList.add('text-red-500');
                                    icon.setAttribute('fill', 'currentColor');
                                } else {
                                    this.classList.remove('text-red-500');
                                    icon.setAttribute('fill', 'none');
                                }
                            }
                        });
                });
            });
        })();
    </script>
{% endblock %}
