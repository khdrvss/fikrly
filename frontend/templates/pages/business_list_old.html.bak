{% extends 'base.html' %}
{% load static i18n render_stars %}


{% block title %}
{% if category_filter %}
{% blocktrans %}{{ category_filter }} ‚Äî Fikrly.uz sharhlari va reytinglari{% endblocktrans %}
{% else %}
{% trans "Bizneslar ro‚Äòyxati ‚Äî Fikrly.uz" %}
{% endif %}
{% endblock %}

{% block meta_description %}
{% if category_filter %}
{% blocktrans %}{{ category_filter }} bo‚Äòyicha O‚Äòzbekistondagi kompaniyalar haqida sharhlar, baholar va foydalanuvchi fikrlari. Fikrly.uz orqali qaysi kompaniya yaxshiroq ekanini bilib oling.{% endblocktrans %}
{% else %}
{% trans "Fikrly.uz ‚Äî O‚Äòzbekistondagi barcha bizneslar va xizmatlar ro‚Äòyxati. Sharhlar o‚Äòqing va qoldiring." %}
{% endif %}
{% endblock %}

{% block content %}
{% load url_params %}
{% load query_helpers %}
<div class="max-w-7xl mx-auto px-6 py-10">
    <!-- Breadcrumbs -->
    <nav class="flex mb-8" aria-label="Breadcrumb">
            <ol class="inline-flex items-center space-x-1 md:space-x-3">
                <li class="inline-flex items-center">
                    <a href="{% url 'index' %}"
                        class="inline-flex items-center text-sm font-medium text-[var(--text-secondary)] hover:text-[var(--accent)]">
                        <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path
                                d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z">
                            </path>
                        </svg>
                        {% trans "Bosh sahifa" %}
                    </a>
                </li>
                {% if category_filter %}
                <li>
                    <div class="flex items-center">
                        <svg class="w-6 h-6 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd"
                                d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z"
                                clip-rule="evenodd"></path>
                        </svg>
                        <a href="{% url 'category_browse' %}"
                            class="ml-1 text-sm font-medium text-[var(--text-secondary)] hover:text-[var(--accent)] md:ml-2">{% trans
                            "Kategoriyalar" %}</a>
                    </div>
                </li>
                <li aria-current="page">
                    <div class="flex items-center">
                        <svg class="w-6 h-6 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd"
                                d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z"
                                clip-rule="evenodd"></path>
                        </svg>
                        <span class="ml-1 text-sm font-medium text-[var(--text-primary)] md:ml-2">{{ category_filter }}</span>
                    </div>
                </li>
                {% else %}
                <li aria-current="page">
                    <div class="flex items-center">
                        <svg class="w-6 h-6 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd"
                                d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z"
                                clip-rule="evenodd"></path>
                        </svg>
                        <span class="ml-1 text-sm font-medium text-[var(--text-primary)] md:ml-2">{% trans "Bizneslar" %}</span>
                    </div>
                </li>
                {% endif %}
            </ol>
    </nav>

    <!-- Header & Search -->
    <div class="flex items-center justify-between mb-8">
        <div>
            <h1 class="text-3xl font-bold text-[var(--text-primary)]">
                    {% if search_query %}
                    {% if category_filter %}
                    {{ category_filter }}
                    {% else %}
                    {% trans "Qidiruv natijalari" %}
                    {% endif %}
                    {% else %}
                    {% trans "Barcha bizneslar" %}
                    {% endif %}
            </h1>
            {% if search_query %}
            <p class="text-[var(--text-secondary)] mt-1">
                "{{ search_query }}" bo'yicha {{ search_results_count }} ta natija
            </p>
            {% else %}
            <p class="text-[var(--text-secondary)] mt-1">{% trans "Eng yaxshi kompaniyalar va xizmatlarni toping" %}</p>
            {% endif %}
        </div>

        <form method="get" id="searchForm" class="w-80">
            <div class="relative">
                <input type="text"
                    name="q"
                    value="{{ request.GET.q }}"
                    placeholder="{% trans 'Kompaniya nomini qidiring...' %}"
                    class="w-full pl-10 pr-4 py-2.5 rounded-lg border border-[var(--border)] bg-[var(--bg)] text-[var(--text-primary)] focus:ring-2 focus:ring-[var(--accent)] transition"
                    autocomplete="off">
                <div class="absolute left-3 top-1/2 -translate-y-1/2 text-[var(--text-secondary)]">üîç</div>
            </div>
        </form>
    </div>

    <hr class="border-[var(--border)] mb-8">

    <!-- Mobile Filter Toggle -->
    <button id="mobileFilterToggle" class="lg:hidden w-full mb-4 px-4 py-3 bg-[var(--surface)] border border-[var(--border)] rounded-lg flex items-center justify-between text-[var(--text-primary)] hover:bg-[var(--bg)] transition">
        <span class="font-semibold">{% trans "Filtrlar" %}</span>
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
    </button>

    <!-- Main Layout -->
    <div class="flex gap-8">
        <!-- Sidebar -->
        <aside id="filtersSidebar" class="w-[280px] shrink-0 hidden lg:block" aria-labelledby="filtersHeading">
            <div class="bg-[var(--surface)] rounded-lg border border-[var(--border)] p-6 space-y-6 sticky top-[110px]">
                <h2 id="filtersHeading" class="text-lg font-semibold text-[var(--text-primary)] mb-4">{% trans "Filtrlar" %}</h2>
                <form id="filtersForm" method="get" action="{% url 'business_list' %}">
                    <input type="hidden" name="q" value="{{ selected_filters.q }}">
                    <input type="hidden" name="sort" value="{{ selected_filters.sort }}">

                    <!-- City -->
                    <div>
                        <h3 class="text-sm font-semibold text-[var(--text-primary)] mb-2">{% trans "Shahar" %}</h3>
                            <select name="city" class="w-full rounded-lg border border-[var(--border)] py-2 px-3 bg-[var(--bg)] text-[var(--text-primary)]" aria-label="{% trans 'Shahar tanlang' %}">
                            <option value="">{% trans "Barcha shaharlar" %}</option>
                            {% for ct in all_cities %}
                                {% if ct %}
                                <option value="{{ ct }}" {% if selected_filters.city == ct %}selected{% endif %}>{{ ct }}</option>
                                {% endif %}
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Categories -->
                    <div>
                        <h3 class="text-sm font-semibold text-[var(--text-primary)] mb-2">{% trans "Kategoriyalar" %}</h3>
                        <div class="max-h-64 overflow-y-auto pr-2 space-y-2">
                            {% for cat in all_categories %}
                            <div class="flex items-center gap-2">
                                <input id="cat-{{ cat.id }}" type="checkbox" class="category-checkbox h-4 w-4 rounded accent-emerald-500 border-gray-300 focus-visible:ring-2 focus-visible:ring-emerald-500 focus-visible:ring-offset-1" value="{{ cat.id }}" {% if cat.id|stringformat:"s" in selected_filters.categories %}checked{% endif %} aria-label="{{ cat.display_name }}">
                                <label for="cat-{{ cat.id }}" class="cursor-pointer select-none text-sm">{{ cat.display_name }} <span class="text-xs text-gray-400">({{ cat.company_count }})</span></label>
                            </div>
                            {% endfor %}
                        </div>
                    </div>

                    <!-- Minimal rating -->
                    <div>
                        <h3 class="text-sm font-semibold text-[var(--text-primary)] mb-2">{% trans "Minimal baho" %}</h3>
                        <div class="flex flex-col gap-2">
                            <div class="flex items-center gap-3">
                                <input id="rating-5" type="radio" name="min_rating" value="5" class="accent-emerald-500 h-4 w-4 focus-visible:ring-2 focus-visible:ring-emerald-500 focus-visible:ring-offset-1" {% if selected_filters.min_rating == '5' %}checked{% endif %}>
                                <label for="rating-5" class="cursor-pointer select-none text-sm">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ &amp; up</label>
                            </div>
                            <div class="flex items-center gap-3">
                                <input id="rating-4" type="radio" name="min_rating" value="4" class="accent-emerald-500 h-4 w-4 focus-visible:ring-2 focus-visible:ring-emerald-500 focus-visible:ring-offset-1" {% if selected_filters.min_rating == '4' %}checked{% endif %}>
                                <label for="rating-4" class="cursor-pointer select-none text-sm">‚òÖ‚òÖ‚òÖ‚òÖ &amp; up</label>
                            </div>
                            <div class="flex items-center gap-3">
                                <input id="rating-3" type="radio" name="min_rating" value="3" class="accent-emerald-500 h-4 w-4 focus-visible:ring-2 focus-visible:ring-emerald-500 focus-visible:ring-offset-1" {% if selected_filters.min_rating == '3' %}checked{% endif %}>
                                <label for="rating-3" class="cursor-pointer select-none text-sm">‚òÖ‚òÖ‚òÖ &amp; up</label>
                            </div>
                            <div class="flex items-center gap-3">
                                <input id="rating-2" type="radio" name="min_rating" value="2" class="accent-emerald-500 h-4 w-4 focus-visible:ring-2 focus-visible:ring-emerald-500 focus-visible:ring-offset-1" {% if selected_filters.min_rating == '2' %}checked{% endif %}>
                                <label for="rating-2" class="cursor-pointer select-none text-sm">‚òÖ‚òÖ &amp; up</label>
                            </div>
                            <div class="flex items-center gap-3">
                                <input id="rating-1" type="radio" name="min_rating" value="1" class="accent-emerald-500 h-4 w-4 focus-visible:ring-2 focus-visible:ring-emerald-500 focus-visible:ring-offset-1" {% if selected_filters.min_rating == '1' %}checked{% endif %}>
                                <label for="rating-1" class="cursor-pointer select-none text-sm">‚òÖ &amp; up</label>
                            </div>
                        </div>
                    </div>

                    <!-- Verified toggle -->
                    <div>
                        <label class="flex items-center gap-3">
                            <input type="checkbox" id="verifiedToggle" name="verified" value="1" class="accent-emerald-500" {% if selected_filters.verified == '1' %}checked{% endif %}>
                            <span class="text-sm">{% trans "Faqat tasdiqlangan" %}</span>
                        </label>
                    </div>

                    <div class="space-y-2">
                        <button type="submit" class="w-full py-2.5 rounded-lg bg-[var(--accent)] text-white hover:opacity-90 transition">{% trans "Qo'llash" %}</button>
                        <a href="{% url 'business_list' %}" class="w-full py-2.5 rounded-lg border border-[var(--border)] hover:bg-[var(--bg)] transition inline-block text-center text-[var(--text-primary)]">{% trans "Filtrlarni tozalash" %}</a>
                    </div>
                </form>
            </div>
        </aside>

        <!-- Content -->
        <div class="flex-1 min-w-0">
            <!-- Top Controls -->
            <div class="flex items-center justify-between mb-6">
                <p class="text-sm text-[var(--text-secondary)]">
                    {{ search_results_count }} {% trans "kompaniya topildi" %}
                </p>
                <div class="flex items-center gap-2">
                    <label class="text-sm text-[var(--text-secondary)]">{% trans "Sort" %}:</label>
                    <select id="sortSelect" name="sort" class="rounded-lg border border-[var(--border)] py-2 px-3 bg-[var(--surface)] text-[var(--text-primary)]">
                                <option value="top" {% if selected_filters.sort == 'top' %}selected{% endif %}>{% trans "Top" %}</option>
                                <option value="new" {% if selected_filters.sort == 'new' %}selected{% endif %}>{% trans "Newest" %}</option>
                                <option value="most_reviews" {% if selected_filters.sort == 'most_reviews' %}selected{% endif %}>{% trans "Most reviews" %}</option>
                                <option value="az" {% if selected_filters.sort == 'az' %}selected{% endif %}>{% trans "A-Z" %}</option>
                    </select>
                </div>
            </div>

            {% if request.GET %}
            <div class="flex flex-wrap gap-2 mb-6 items-center">
                    {% if selected_filters.city %}
                    <a href="?{% querystring_without 'city' %}" class="inline-flex items-center gap-2 px-3 py-1.5 rounded-full bg-green-50 text-green-600 text-sm hover:bg-green-100 transition">{% trans "Shahar:" %} {{ selected_filters.city }} ‚úï</a>
                    {% endif %}

                    {% if selected_filters.categories %}
                        {% for cat in all_categories %}
                            {% if cat.id|stringformat:"s" in selected_filters.categories %}
                                <a href="?{% remove_category_query cat.id %}" class="inline-flex items-center gap-2 px-3 py-1.5 rounded-full bg-green-50 text-green-600 text-sm hover:bg-green-100 transition">{{ cat.display_name }} ‚úï</a>
                            {% endif %}
                        {% endfor %}
                    {% endif %}

                    {% if selected_filters.min_rating %}
                    <a href="?{% querystring_without 'min_rating' %}" class="inline-flex items-center gap-2 px-3 py-1.5 rounded-full bg-green-50 text-green-600 text-sm hover:bg-green-100 transition">{{ selected_filters.min_rating }}‚òÖ & up ‚úï</a>
                    {% endif %}

                    {% if selected_filters.verified == '1' %}
                    <a href="?{% querystring_without 'verified' %}" class="inline-flex items-center gap-2 px-3 py-1.5 rounded-full bg-green-50 text-green-600 text-sm hover:bg-green-100 transition">{% trans "Faqat tasdiqlangan" %} ‚úï</a>
                    {% endif %}

                <a href="{% url 'business_list' %}" class="text-sm text-[var(--text-secondary)] hover:text-[var(--text-primary)] ml-2">Barchasini tozalash</a>
            </div>
            {% endif %}

            <!-- Business Cards Grid -->
            <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6" id="businessGrid">

                <!-- Skeleton placeholders -->
                <div id="skeleton-grid" class="contents">
                        {% for i in "123456"|make_list %}
                              <div class="animate-pulse bg-[var(--surface)] rounded-xl p-4 border border-[var(--border)] shadow-sm">
                                  <div class="aspect-[16/9] bg-gray-200 dark:bg-gray-700 rounded-xl mb-4"></div>
                                  <div class="h-4 bg-gray-200 dark:bg-gray-700 rounded w-3/4 mb-3"></div>
                                  <div class="h-3 bg-gray-200 dark:bg-gray-700 rounded w-1/2 mb-2"></div>
                                  <div class="h-8 bg-gray-200 dark:bg-gray-700 rounded-xl mt-4"></div>
                              </div>
                        {% endfor %}
                    </div>

            {% for c in companies %}
            <div class="group relative">

                <div class="bg-[var(--surface)] border border-[var(--border)] rounded-xl shadow-sm hover:shadow-md transition-all duration-300 hover:-translate-y-1 overflow-hidden relative">

                <!-- Full-card overlay link (avoids nested anchors) -->
                <a href="{% url 'company_detail' c.pk %}" class="absolute inset-0 z-10 focus:outline-none focus:ring-2 focus:ring-emerald-500 rounded-2xl" aria-label="{{ c.name }}"></a>

                <div class="relative z-0">
                <div class="relative overflow-hidden aspect-[16/9] bg-[var(--bg)]">

                    <!-- shimmer placeholder while image loads -->
                    <div class="absolute inset-0 animate-pulse bg-gradient-to-r from-gray-200 via-gray-100 to-gray-200"></div>

                    <img
                        src="{{ c.image_800_url|default:c.display_image_url|default:c.image_url|default:'' }}"
                        srcset="{{ c.image_400_url }} 400w, {{ c.image_800_url }} 800w, {{ c.image_1200_url }} 1200w"
                        sizes="(max-width: 768px) 100vw, 33vw"
                        alt="{{ c.name }}"
                        class="absolute inset-0 w-full h-full object-cover opacity-0 transition-opacity duration-700 group-hover:scale-105 transition-transform duration-500"
                        onload="this.classList.remove('opacity-0')" onerror="this.onerror=null;this.src='{% static 'img/placeholder-2x1.svg' %}';"
                        {% if forloop.counter <= 3 %}loading="eager" fetchpriority="high" decoding="async"{% else %}loading="lazy" decoding="async"{% endif %}>

                    <!-- rating badge (top-right) -->
                    <div class="absolute top-3 right-3 bg-[var(--surface)]/90 backdrop-blur-md px-3 py-1 rounded-full text-sm font-semibold shadow-md flex items-center gap-1 text-[var(--text-primary)]">
                        <svg class="w-4 h-4 text-yellow-500" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.286 3.97a1 1 0 00.95.69h4.178c.969 0 1.371 1.24.588 1.81l-3.38 2.455a1 1 0 00-.364 1.118l1.287 3.97c.3.921-.755 1.688-1.54 1.118l-3.38-2.455a1 1 0 00-1.176 0L5.21 17.958c-.785.57-1.84-.197-1.54-1.118l1.287-3.97a1 1 0 00-.364-1.118L1.213 8.297c-.783-.57-.38-1.81.588-1.81h4.178a1 1 0 00.95-.69l1.286-3.97z"/></svg>
                        <span class="text-[var(--text-primary)]">{{ c.rating|floatformat:1 }}</span>
                    </div>

                    <!-- logo small circle (top-left) -->
                    <div class="absolute top-3 left-3 bg-[var(--surface)] p-1 rounded-lg shadow overflow-hidden w-10 h-10">
                        <div class="w-full h-full rounded-md overflow-hidden relative">
                            {% if c.display_logo %}
                            <img data-src="{{ c.display_logo }}" alt="{{ c.name }} logo" class="w-full h-full object-cover absolute inset-0" style="transform: scale(calc({{ c.logo_scale|default:100 }} / 100));" onerror="this.onerror=null;this.src='https://api.dicebear.com/7.x/shapes/svg?seed={{ c.name|urlencode }}&backgroundColor=b6e3f4,c0aede,d1d4f9&backgroundType=gradientLinear';">
                            {% else %}
                            <img data-src="https://api.dicebear.com/7.x/shapes/svg?seed={{ c.name|urlencode }}&backgroundColor=b6e3f4,c0aede,d1d4f9&backgroundType=gradientLinear" alt="Logo" class="w-full h-full object-cover">
                            {% endif %}
                        </div>
                    </div>

                    <!-- business name on hover -->
                    <div class="absolute bottom-3 left-3 text-white text-sm font-semibold opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                        {{ c.name }}
                    </div>

                </div>
                <div class="p-6 flex-1 flex flex-col">
                    <div class="mb-4">
                        <div class="flex items-start justify-between mb-1">
                            {% with cat=c.category_fk %}
                            <span class="inline-block text-xs font-semibold px-3 py-1 rounded-full bg-green-50 text-green-600 uppercase tracking-wide">
                                {{ cat.display_name|default:c.category }}
                            </span>
                            {% endwith %}
                            <span class="text-xs text-gray-400">{% blocktrans with count=c.review_count %}{{ count }}
                                sharh{% endblocktrans %}</span>

                        </div>
                        <h3
                            class="text-xl font-bold text-[var(--text-primary)] group-hover:text-[var(--accent)] transition-colors line-clamp-1 flex items-center gap-1 relative z-10 pointer-events-none">
                            {{ c.name }}
                            {% if c.is_verified %}
                            <span class="relative flex items-center justify-center">
                                <span class="absolute inline-flex h-full w-full rounded-full bg-emerald-400 opacity-20 animate-ping"></span>
                                <svg class="relative w-5 h-5 text-green-500 z-10 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd"
                                        d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
                                        clip-rule="evenodd" />
                                </svg>
                            </span>
                            {% endif %}
                        </h3>
                        {% if c.city %}
                        <div class="flex items-center gap-1 text-sm text-[var(--text-secondary)] mt-1">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z">
                                </path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                            </svg>
                            {{ c.city }}
                        </div>
                        {% endif %}
                    </div>

                    {% if c.display_description %}
                    <p class="text-[var(--text-secondary)] text-sm line-clamp-2 mb-4 flex-1">{{ c.display_description }}</p>
                    {% else %}
                    <div class="flex-1"></div>
                    {% endif %}

                    <a href="{% url 'review_submission' %}?company={{ c.pk }}" class="w-full py-2.5 rounded-xl border border-[var(--border)] text-[var(--text-primary)] font-medium hover:border-[var(--accent)] hover:text-[var(--accent)] transition-colors flex items-center justify-center gap-2 relative z-20">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z">
                            </path>
                        </svg>
                        {% trans "Sharh yozish" %}
                    </a>
                    </div>

                    </div>
                </div>
            
            {% empty %}
            <div class="w-full py-16 text-center">
                <div class="text-5xl mb-4">üîç</div>
                <h3 class="text-xl font-semibold text-[var(--text-primary)] mb-2">{% trans "Hech qanday natija topilmadi" %}</h3>
                <p class="text-[var(--text-secondary)] mb-6">{% trans "Filtrlarni o'zgartiring yoki boshqa kategoriya sinab ko'ring." %}</p>
                <a href="{% url 'business_list' %}"
                   class="px-6 py-3 rounded-xl bg-[var(--accent)] text-white hover:opacity-90 transition">{% trans "Filtrlarni tozalash" %}</a>
            </div>
            {% endfor %}
            </div>

        <!-- Pagination -->
        {% if page_obj.has_other_pages %}
        <div class="mt-10 flex justify-center">
            <nav class="flex items-center space-x-2" aria-label="Pagination">
                {% if page_obj.has_previous %}
                <a href="?{% url_replace request 'page' page_obj.previous_page_number %}"
                    class="px-4 py-2 rounded-lg border border-[var(--border)] bg-[var(--surface)] text-[var(--text-secondary)] hover:bg-[var(--accent)] hover:text-white transition">
                    <span class="sr-only">{% trans "Oldingi" %}</span>
                    ‚Üê
                </a>
                {% endif %}

                {% for num in page_obj.paginator.page_range %}
                    <a href="?{% url_replace request 'page' num %}"
                       class="px-4 py-2 rounded-lg border border-[var(--border)] {% if page_obj.number == num %}bg-[var(--accent)] text-white{% else %}bg-[var(--surface)] text-[var(--text-primary)] hover:bg-[var(--accent)] hover:text-white{% endif %} transition">
                        {{ num }}
                    </a>
                {% endfor %}

                {% if page_obj.has_next %}
                <a href="?{% url_replace request 'page' page_obj.next_page_number %}"
                    class="px-4 py-2 rounded-lg border border-[var(--border)] bg-[var(--surface)] text-[var(--text-secondary)] hover:bg-[var(--accent)] hover:text-white transition">
                    <span class="sr-only">{% trans "Keyingi" %}</span>
                    ‚Üí
                </a>
                {% endif %}
            </nav>
        </div>
        {% endif %}

      </div> <!-- Close content area (flex-1 min-w-0) -->
    </div> <!-- Close main layout (flex gap-8) -->
</div> <!-- Close container (max-w-7xl) -->
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const searchForm = document.getElementById('searchForm');
        const searchInput = document.getElementById('searchInput');
        const suggestionsBox = document.getElementById('searchSuggestions');
        let debounceTimer;

        if (searchInput) {
            // Live Search Logic
            searchInput.addEventListener('input', function () {
                const query = this.value.trim();

                clearTimeout(debounceTimer);

                if (query.length < 2) {
                    suggestionsBox.classList.add('hidden');
                    suggestionsBox.innerHTML = '';
                    return;
                }

                debounceTimer = setTimeout(() => {
                    fetch(`{% url 'search_suggestions_api' %}?q=${encodeURIComponent(query)}`)
                        .then(response => response.json())
                        .then(data => {
                            if (data.results && data.results.length > 0) {
                                renderSuggestions(data.results);
                            } else {
                                suggestionsBox.classList.add('hidden');
                            }
                        })
                        .catch(err => console.error('Search error:', err));
                }, 300);
            });

            // Close suggestions when clicking outside
            document.addEventListener('click', function (e) {
                if (!searchForm.contains(e.target)) {
                    suggestionsBox.classList.add('hidden');
                }
            });
        }

        function renderSuggestions(results) {
            let html = '<ul class="py-2">';

            results.forEach(item => {
                if (item.type === 'category') {
                    html += `
                            <li>
                                <a href="${item.url}" class="flex items-center px-4 py-3 hover:bg-[var(--bg)] transition-colors">
                                    <div class="flex-shrink-0 w-10 h-10 rounded-lg bg-primary-50 text-[var(--accent)] flex items-center justify-center mr-3">
                                        ${item.icon ? `<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">${item.icon}</svg>` :
                            `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>`}
                                    </div>
                                    <div>
                                        <div class="font-medium text-[var(--text-primary)]">${item.name}</div>
                                        <div class="text-xs text-[var(--text-secondary)]">{% trans "Kategoriya" %}</div>
                                    </div>
                                </a>
                            </li>
                        `;
                } else {
                    // Company
                    const logoUrl = item.logo || item.image || "{% static 'images/placeholder.png' %}";
                    const scale = item.logo_scale || 100;

                    const imgHtml = `
                            <div class="flex-shrink-0 w-10 h-10 rounded-lg bg-[var(--surface)] mr-3 relative overflow-hidden">
                                <img src="${logoUrl}"
                                     class="absolute inset-0 w-full h-full object-cover"
                                     alt="${item.name}"
                                     style="transform: scale(${scale / 100});"
                                     onerror="this.src='{% static 'images/placeholder.png' %}'">
                            </div>`;

                    html += `
                            <li>
                                <a href="${item.url}" class="flex items-center px-4 py-3 hover:bg-[var(--bg)] transition-colors">
                                    ${imgHtml}
                                    <div>
                                        <div class="font-medium text-[var(--text-primary)]">${item.name}</div>
                                        <div class="text-xs text-[var(--text-secondary)]">${item.category || '{% trans "Biznes" %}'}</div>
                                    </div>
                                </a>
                            </li>
                        `;
                }
            });

            html += '</ul>';
            suggestionsBox.innerHTML = html;
            suggestionsBox.classList.remove('hidden');
        }
    });
</script>
<script>
document.addEventListener('DOMContentLoaded', function(){
    const filtersForm = document.getElementById('filtersForm');
    const categoryCheckboxes = document.querySelectorAll('.category-checkbox');
    const sortSelect = document.getElementById('sortSelect');

    function submitFilters(){
        // Build categories CSV
        const vals = [];
        categoryCheckboxes.forEach(cb => { if(cb.checked) vals.push(cb.value); });
        // Remove existing category inputs
        // Create a params object from current form
        const form = filtersForm;
        // ensure a hidden input for categories
        let hidden = form.querySelector('input[name="categories"]');
        if(!hidden){ hidden = document.createElement('input'); hidden.type='hidden'; hidden.name='categories'; form.appendChild(hidden); }
        hidden.value = vals.join(',');

        // If verified checkbox unchecked, remove param
        const verified = form.querySelector('#verifiedToggle');
        if(verified && !verified.checked){
            const v = form.querySelector('input[name="verified"]'); if(v) v.disabled = true;
        }

        form.submit();
    }

    if(categoryCheckboxes.length){
        categoryCheckboxes.forEach(cb => cb.addEventListener('change', function(){
            // on desktop change, auto-submit
            if(window.innerWidth >= 1024){ submitFilters(); }
        }));
    }

    if(sortSelect){
        sortSelect.addEventListener('change', function(){
            // set value in hidden sort input and submit
            const sortInput = document.createElement('input'); sortInput.type='hidden'; sortInput.name='sort'; sortInput.value=this.value; filtersForm.appendChild(sortInput);
            submitFilters();
        });
    }

    // On mobile, keep a manual submit button (Qo'llash)
    const applyBtn = filtersForm.querySelector('button[type="submit"]');
    if(applyBtn){ applyBtn.addEventListener('click', function(e){ /* allow default submit */ }); }
});
</script>

<script>
document.addEventListener("DOMContentLoaded", function() {
    const skeleton = document.getElementById("skeleton-grid");
    if (skeleton) skeleton.style.display = "none";
    
    // Mobile filter toggle
    const toggleBtn = document.getElementById("mobileFilterToggle");
    const sidebar = document.getElementById("filtersSidebar");
    
    if (toggleBtn && sidebar) {
        toggleBtn.addEventListener("click", function() {
            sidebar.classList.toggle("hidden");
            sidebar.classList.toggle("block");
            
            // Rotate chevron
            const chevron = this.querySelector("svg");
            if (sidebar.classList.contains("block")) {
                chevron.style.transform = "rotate(180deg)";
                sidebar.classList.remove("w-[280px]", "shrink-0");
                sidebar.classList.add("w-full", "mb-4");
            } else {
                chevron.style.transform = "rotate(0deg)";
                sidebar.classList.remove("w-full", "mb-4");
                sidebar.classList.add("w-[280px]", "shrink-0");
            }
        });
    }
});
</script>
{% endblock %}